<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Primary identity (helps Google pick the right sitename) -->
  <title>ZIP 4 — Online file converter</title>
  <meta name="application-name" content="ZIP 4">
  <meta name="description" content="ZIP 4 is a fast, privacy-first online file converter. Convert, resize, compress, and download — in a clean workflow." />

  <!-- Indexing / canonical -->
  <meta name="robots" content="index,follow" />
  <link rel="canonical" href="https://zip4.dev/" />

  <!-- Theme / icons -->
  <meta name="theme-color" content="#161618">
  <link rel="icon" href="./Logo.png" type="image/png" />
  <link rel="apple-touch-icon" href="./Logo.png" />

  <!-- Open Graph (social previews) -->
  <meta property="og:type" content="website" />
  <meta property="og:site_name" content="ZIP 4" />
  <meta property="og:title" content="ZIP 4" />
  <meta property="og:description" content="Fast, privacy-first online file converter. Convert, resize, compress, and download." />
  <meta property="og:url" content="https://zip4.dev/" />

  <!-- Twitter cards -->
  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="ZIP 4" />
  <meta name="twitter:description" content="Fast, privacy-first online file converter. Convert, resize, compress, and download." />

  <!-- Structured data (explicit sitename for Google) -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "WebSite",
    "name": "ZIP 4",
    "alternateName": "ZIP4",
    "url": "https://zip4.dev/"
  }
  </script>

  <style>
    :root{
      --title:#2C2C2E;
      --text:#3A3A3C;
      --muted:#6E6E73;
      --border:rgba(0,0,0,.12);
      --bgSoft:rgba(0,0,0,.02);
      --shadow:rgba(0,0,0,.10);
      --easeOut:cubic-bezier(.2,.8,.2,1);
    }

    *{box-sizing:border-box}

    @media (prefers-reduced-motion: reduce){
      *, *::before, *::after{animation:none !important; transition:none !important; scroll-behavior:auto !important;}
    }

    @keyframes fadeUp{
      from{opacity:0; transform:translateY(10px);}
      to{opacity:1; transform:translateY(0);}
    }

    body{
      margin:0;
      font-family:-apple-system,BlinkMacSystemFont,"SF Pro Text","SF Pro Display","Helvetica Neue",Arial,sans-serif;
      color:var(--text);
      background:#fff;
    }

    html, body{ height:100%; }

    /* Space for pinned topbar.js */
    main{
      min-height:100%;
      padding:88px 28px 32px;
      display:flex;
      flex-direction:column;
    }

    /* Wider overall layout */
    .shell{
      max-width:1120px;
      margin:0 auto;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:14px;
      animation:fadeUp .55s var(--easeOut) both;
    }

    h1{
      margin:6px 0 0;
      font-size:clamp(26px,3vw,40px);
      font-weight:760;
      letter-spacing:-.03em;
      color:var(--title);
      text-align:center;
      animation:fadeUp .6s var(--easeOut) both;
      animation-delay:.04s;
    }

    .sub{
      margin:0;
      font-size:13px;
      color:var(--muted);
      text-align:center;
      max-width:760px;
      line-height:1.35;
      animation:fadeUp .6s var(--easeOut) both;
      animation-delay:.08s;
    }

    /* BIG plateau */
    .plate{
      width:min(980px, 94vw);
      margin-top:18px;
      padding:18px;
      border-radius:26px;
      border:1px solid var(--border);
      background:rgba(0,0,0,.015);
      box-shadow:0 26px 80px rgba(0,0,0,.10);
      display:flex;
      flex-direction:column;
      gap:14px;
      animation:fadeUp .65s var(--easeOut) both;
      animation-delay:.12s;
      transition:transform .2s var(--easeOut), box-shadow .2s var(--easeOut);
    }

    .plate:hover{
      transform:translateY(-2px);
      box-shadow:0 30px 90px rgba(0,0,0,.12);
    }

    /* Drop zone feedback */
    .drop{
      border:1px dashed rgba(0,0,0,.20);
      border-radius:20px;
      padding:18px 16px;
      text-align:center;
      background:rgba(0,0,0,.012);
      display:flex;
      flex-direction:column;
      gap:10px;
      align-items:center;
      justify-content:center;
      min-height:120px;
      transition:background .2s var(--easeOut), border-color .2s var(--easeOut), transform .2s var(--easeOut);
    }
    .drop.isDragOver{
      background:rgba(0,0,0,.02);
      border-color:rgba(0,0,0,.28);
      transform:scale(1.01);
    }

    .fileLine{
      font-size:12px;
      color:var(--muted);
      max-width:90%;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }

    /* Buttons */
    .btn{
      border:1px solid var(--border);
      background:#fff;
      border-radius:999px;
      padding:9px 14px;
      font-size:13px;
      cursor:pointer;
      transition:transform .12s var(--easeOut), opacity .15s var(--easeOut), background .2s var(--easeOut), border-color .2s var(--easeOut);
      user-select:none;
    }
    .btn:hover{transform:translateY(-1px);}
    .btn:active{transform:scale(.98);}

    .btnPrimary{
      background:#2C2C2E;
      color:#fff;
      border-color:#2C2C2E;
      font-weight:650;
    }

    .btnDisabled{opacity:.5;pointer-events:none}

    .divider{height:1px;background:rgba(0,0,0,.06); margin:2px 0}

    /* Format section */
    .formatBlock{display:none}
    .centerStack{
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:10px;
      padding:6px 0 2px;
    }

    .label{
      font-size:11px;
      letter-spacing:.08em;
      text-transform:uppercase;
      color:rgba(60,60,67,.55);
    }

    select{
      width:min(420px, 84vw);
      padding:10px 12px;
      border-radius:14px;
      border:1px solid var(--border);
      font-size:14px;
      background:#fff;
      outline:none;
    }

    .qualityWrap{
      display:none;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      justify-content:center;
      margin-top:4px;
    }

    .qualityWrap .qSmall{
      font-size:12px;
      color:var(--muted);
    }

    .actions{
      display:flex;
      gap:10px;
      justify-content:center;
      margin-top:6px;
    }

    /* Result row */
    @keyframes slideIn{
      from{opacity:0; transform:translateY(8px);}
      to{opacity:1; transform:translateY(0);}
    }
    .doneRow{
      display:none;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding:12px 14px;
      border-radius:18px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.70);
      backdrop-filter:saturate(1.4) blur(10px);
      transition:opacity .2s var(--easeOut);
    }
    .doneRow.isVisible{
      animation:slideIn .35s var(--easeOut) both;
    }

    .doneMeta{
      display:flex;
      flex-direction:column;
      gap:2px;
      min-width:0;
    }
    .doneName{
      font-size:13px;
      font-weight:650;
      color:var(--title);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width:560px;
    }
    .doneSize{
      font-size:12px;
      color:var(--muted);
    }

    /* Mobile tweaks */
    @media (max-width: 720px){
      main{padding:84px 16px 60px}
      .plate{padding:14px}
      .doneName{max-width:240px}
    }

    /* Bottom CTA card */
    .infoCard{
      width:min(980px, 94vw);
      margin-top:18px;
      border-radius:22px;
      border:1px solid rgba(0,0,0,.10);
      background:rgba(0,0,0,.012);
      padding:16px;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:12px;
      box-shadow:0 18px 52px rgba(0,0,0,.06);
      animation:fadeUp .65s var(--easeOut) both;
      animation-delay:.18s;
    }

    .infoText{
      font-size:13px;
      color:rgba(60,60,67,.72);
      line-height:1.4;
      text-align:center;
    }

    .infoBtn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      padding:9px 14px;
      border-radius:999px;
      border:1px solid rgba(0,0,0,.12);
      background:#fff;
      color:rgba(44,44,46,.92);
      text-decoration:none;
      font-size:13px;
      font-weight:650;
      transition:transform .12s var(--easeOut), background .2s var(--easeOut), border-color .2s var(--easeOut);
      user-select:none;
    }

    .infoBtn:hover{ transform:translateY(-1px); background:rgba(0,0,0,.02); border-color:rgba(0,0,0,.14); }
    .infoBtn:active{ transform:scale(.98); }

    .infoBtn .arrow{ opacity:.7; }

    @media (max-width: 720px){
      .infoCard{ padding:14px; flex-direction:column; gap:10px; }
      .infoText{ max-width:320px; }
    }

    footer{
      margin-top:auto;
      border-top:1px solid rgba(0,0,0,.08);
      padding:22px 0;
      font-size:12px;
      color: rgba(60,60,67,.55);
      text-align:center;
      background:#fff;
    }
  </style>
</head>

<body>
  <!-- ✅ Topbar -->
  <script src="./topbar.js"></script>

  <main>
    <div class="shell">
      <h1>Convert. Resize. Download. Done.</h1>
      <p class="sub">Pick a file. Choose a format. Resize or compress. Download the result.</p>

      <div class="plate" id="plate">
        <!-- accept: “preparato” per immagini moderne (HEIC/HEIF/TIFF) + generico -->
        <input type="file" id="fileInput" hidden accept="image/*,.heic,.heif,.tif,.tiff,application/pdf,*/*">

        <div class="drop" id="dropZone">
          <div class="fileLine" id="fileLabel">No file selected</div>
          <button class="btn btnPrimary" id="pickBtn">Select file</button>
        </div>

        <div class="divider"></div>

        <div class="formatBlock" id="formatBlock">
          <div class="centerStack">
            <div class="label">Output format</div>

            <select id="formatSelect">
              <option value="">Choose format</option>
            </select>

            <!-- Target size (compression / reduce file weight) -->
            <div class="qualityWrap" id="targetWrap" style="display:none; margin-top:4px;">
              <span class="qSmall">Target size</span>
              <select id="targetSize" style="width:220px; padding:10px 12px; border-radius:14px; border:1px solid rgba(0,0,0,.12); font-size:14px; background:#fff; outline:none; color:rgba(44,44,46,.92); -webkit-text-fill-color:rgba(44,44,46,.92);">
                <option value="">No limit</option>
              </select>
            </div>

            <!-- Resize (max side in px) -->
            <div class="qualityWrap" id="resizeWrap" style="display:none; margin-top:4px;">
              <span class="qSmall">Resize</span>
              <select id="resizeMax" style="width:220px; padding:10px 12px; border-radius:14px; border:1px solid rgba(0,0,0,.12); font-size:14px; background:#fff; outline:none; color:rgba(44,44,46,.92); -webkit-text-fill-color:rgba(44,44,46,.92);">
                <option value="">Original</option>
                <option value="3840">3840 px</option>
                <option value="2560">2560 px</option>
                <option value="1920">1920 px</option>
                <option value="1280">1280 px</option>
              </select>
            </div>

            <div class="actions">
              <button class="btn btnPrimary btnDisabled" id="convertBtn">Convert</button>
            </div>
          </div>
        </div>

        <div class="doneRow" id="doneRow">
          <div class="doneMeta">
            <div class="doneName" id="doneName">Ready</div>
            <div class="doneSize" id="doneSize">—</div>
          </div>
          <a class="btn btnPrimary" id="downloadBtn" href="#" download>Download</a>
        </div>

      </div>

      <div class="infoCard" aria-label="About ZIP 4">
        <div class="infoText">Learn what ZIP 4 is and how it works — in a simple, clear explanation.</div>
        <a class="infoBtn" href="./what-is-zip4.html">What is ZIP 4?<span class="arrow">→</span></a>
      </div>
    </div>
  </main>

  <footer>
    ZIP 4 — Made to be simple.
  </footer>

  <!-- Core -->
  <script src="./zip4-core.js?v=2"></script>

  <script>
    const fileInput    = document.getElementById('fileInput');
    const pickBtn      = document.getElementById('pickBtn');
    const fileLabel    = document.getElementById('fileLabel');
    const dropZone     = document.getElementById('dropZone');

    const formatBlock  = document.getElementById('formatBlock');
    const formatSelect = document.getElementById('formatSelect');

    const convertBtn   = document.getElementById('convertBtn');

    const doneRow      = document.getElementById('doneRow');
    const downloadBtn  = document.getElementById('downloadBtn');
    const doneName     = document.getElementById('doneName');
    const doneSize     = document.getElementById('doneSize');

    const targetWrap   = document.getElementById('targetWrap');
    const targetSize   = document.getElementById('targetSize');

    const resizeWrap   = document.getElementById('resizeWrap');
    const resizeMax    = document.getElementById('resizeMax');

    let currentFile = null;

    function isLossyFormat(m){
      return (m === 'image/jpeg' || m === 'image/webp' || m === 'image/avif');
    }

    function isImageInput(file){
      if(!file) return false;
      const t = (file.type || '').toLowerCase();
      const n = (file.name || '').toLowerCase();
      return t.startsWith('image/') || n.endsWith('.heic') || n.endsWith('.heif') || n.endsWith('.tif') || n.endsWith('.tiff');
    }

    function fmt(bytes){
      if(bytes < 1024) return bytes + ' B';
      if(bytes < 1024*1024) return Math.round(bytes/1024) + ' KB';
      return (bytes/1024/1024).toFixed(1) + ' MB';
    }

    function resetResult(){
      doneRow.style.display = 'none';
      doneRow.classList.remove('isVisible');

      if(downloadBtn.dataset.url){
        try{ URL.revokeObjectURL(downloadBtn.dataset.url); }catch{}
        delete downloadBtn.dataset.url;
      }
      downloadBtn.href = '#';
      doneName.textContent = 'Ready';
      doneSize.textContent = '—';
    }

    function updateResizeUI(){
      // Mostriamo resize solo se:
      // - input è immagine
      // - output scelto è un formato lossy (per evitare confusione su ZIP/SHA/etc.)
      const out = formatSelect.value;
      const show = isImageInput(currentFile) && isLossyFormat(out);
      resizeWrap.style.display = show ? 'flex' : 'none';
      if(!show) resizeMax.value = '';
    }

    function populateTargetPresets(){
      const prev = targetSize.value || '';
      const out = formatSelect.value;

      const show = !!currentFile
        && isLossyFormat(out)
        && typeof Zip4Core?.getTargetOptionsForFile === 'function';

      if(!show){
        targetWrap.style.display = 'none';
        targetSize.innerHTML = '<option value="">No limit</option>';
        return;
      }

      const presets = Zip4Core.getTargetOptionsForFile(currentFile, out) || [];
      if(!presets.length){
        targetWrap.style.display = 'none';
        targetSize.innerHTML = '<option value="">No limit</option>';
        return;
      }

      targetWrap.style.display = 'flex';
      targetSize.innerHTML = '<option value="">No limit</option>';

      for(const p of presets){
        const opt = document.createElement('option');
        opt.value = p;
        opt.textContent = p;
        targetSize.appendChild(opt);
      }

      const stillOk = Array.from(targetSize.options).some(o => o.value === prev);
      targetSize.value = stillOk ? prev : '';
    }

    async function populateOutputs(file){
      const prev = formatSelect.value || '';

      if(typeof Zip4Core?.getOutputsForFile !== 'function'){
        // Core non caricato / errore: fallback minimale
        formatSelect.innerHTML = '<option value="">Choose format</option>';
        return;
      }

      const outs = await Zip4Core.getOutputsForFile(file);

      formatSelect.innerHTML = '<option value="">Choose format</option>';

      for(const o of outs){
        const opt = document.createElement('option');
        opt.value = o.value;
        opt.textContent = o.label;

        // Disabilita opzioni incompatibili, MA non disabilitare il valore già selezionato
        if(o.enabled === false && o.value !== prev){
          opt.disabled = true;
        }

        formatSelect.appendChild(opt);
      }

      const hasPrev = outs.some(x => x.value === prev);
      if(hasPrev) formatSelect.value = prev;
    }

    function refreshConvertButton(){
      const selectedOpt = formatSelect.selectedOptions && formatSelect.selectedOptions[0];
      const canConvert = !!formatSelect.value && !(selectedOpt && selectedOpt.disabled);
      convertBtn.classList.toggle('btnDisabled', !canConvert);
    }

    pickBtn.onclick = () => fileInput.click();

    // Drag & drop
    ;['dragenter','dragover'].forEach(evt=>{
      dropZone.addEventListener(evt, (e)=>{
        e.preventDefault();
        e.stopPropagation();
        dropZone.classList.add('isDragOver');
      });
    });
    ;['dragleave','drop'].forEach(evt=>{
      dropZone.addEventListener(evt, (e)=>{
        e.preventDefault();
        e.stopPropagation();
        dropZone.classList.remove('isDragOver');
      });
    });
    dropZone.addEventListener('drop', (e)=>{
      const f = e.dataTransfer.files && e.dataTransfer.files[0];
      if(f){
        fileInput.files = e.dataTransfer.files;
        handleFileSelected(f);
      }
    });

    fileInput.onchange = () => {
      const f = fileInput.files && fileInput.files[0];
      if(f) handleFileSelected(f);
    };

    async function handleFileSelected(file){
      currentFile = file;
      fileLabel.textContent = file.name;
      resetResult();

      await populateOutputs(file);

      formatBlock.style.display = 'block';

      // Aggiorna UI controlli in base alla selezione corrente
      refreshConvertButton();
      populateTargetPresets();
      updateResizeUI();
    }

    formatSelect.onchange = () => {
      refreshConvertButton();
      populateTargetPresets();
      updateResizeUI();
    };

    targetSize.onchange = () => {
      // no-op: value read at conversion time
    };

    resizeMax.onchange = () => {
      // no-op: value read at conversion time
    };

    convertBtn.onclick = async () => {
      if(!currentFile) return;
      const out = formatSelect.value;
      if(!out) return;

      const selectedOpt = formatSelect.selectedOptions && formatSelect.selectedOptions[0];
      if(selectedOpt && selectedOpt.disabled){
        alert('That format is not compatible with this file.');
        return;
      }

      if(typeof Zip4Core?.convert !== 'function'){
        alert('Core not loaded. Check zip4-core.js.');
        return;
      }

      convertBtn.classList.add('btnDisabled');
      convertBtn.textContent = 'Converting…';

      try{
        const preset = (isLossyFormat(out) && targetSize.value) ? targetSize.value : '';
        const rMax = (isLossyFormat(out) && isImageInput(currentFile))
          ? (Number(resizeMax.value || 0) || 0)
          : 0;

        const res = await Zip4Core.convert(
          currentFile,
          out,
          {
            ...(preset ? { target: preset } : {}),
            ...(rMax > 0 ? { resizeMax: rMax } : {})
          }
        );

        const url = URL.createObjectURL(res.blob);
        downloadBtn.href = url;
        downloadBtn.download = res.outName;
        downloadBtn.dataset.url = url;

        doneName.textContent = res.outName;
        doneSize.textContent = fmt(res.blob.size);

        doneRow.style.display = 'flex';
        requestAnimationFrame(()=> doneRow.classList.add('isVisible'));
      }catch(err){
        alert(err?.message || 'Conversion failed.');
      }finally{
        convertBtn.textContent = 'Convert';
        refreshConvertButton();
      }
    };
  </script>
</body>
</html>