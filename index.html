<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="theme-color" content="#161618">
  <title>ZIP 4 — Web Converter</title>

  <style>
    :root{
      --title:#2C2C2E;
      --text:#3A3A3C;
      --muted:#6E6E73;
      --border:rgba(0,0,0,.12);
      --bgSoft:rgba(0,0,0,.02);
      --shadow:rgba(0,0,0,.10);
    }

    *{box-sizing:border-box}

    /* Subtle motion */
    :root{
      --easeOut:cubic-bezier(.2,.8,.2,1);
    }

    @media (prefers-reduced-motion: reduce){
      *, *::before, *::after{animation:none !important; transition:none !important; scroll-behavior:auto !important;}
    }

    @keyframes fadeUp{
      from{opacity:0; transform:translateY(10px);}
      to{opacity:1; transform:translateY(0);}
    }

    body{
      margin:0;
      font-family:-apple-system,BlinkMacSystemFont,"SF Pro Text","SF Pro Display","Helvetica Neue",Arial,sans-serif;
      color:var(--text);
      background:#fff;
    }

    html, body{
      height:100%;
    }

    /* Space for pinned topbar.js */
    main{
      min-height:100%;
      padding:88px 28px 32px;
      display:flex;
      flex-direction:column;
    }

    /* Wider overall layout */
    .shell{
      max-width:1120px;
      margin:0 auto;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:14px;
      animation:fadeUp .55s var(--easeOut) both;
    }

    h1{
      margin:6px 0 0;
      font-size:clamp(26px,3vw,40px);
      font-weight:760;
      letter-spacing:-.03em;
      color:var(--title);
      text-align:center;
      animation:fadeUp .6s var(--easeOut) both;
      animation-delay:.04s;
    }

    .sub{
      margin:0;
      font-size:13px;
      color:var(--muted);
      text-align:center;
      max-width:760px;
      line-height:1.35;
      animation:fadeUp .6s var(--easeOut) both;
      animation-delay:.08s;
    }


    .footerBar{
      margin-top:60px;
      padding:18px 0 24px;
      display:flex;
      justify-content:center;
      border-top:1px solid rgba(0,0,0,.08);
    }

    .footerBar .btn{
      background:#f2f2f2;
      border:1px solid rgba(0,0,0,.15);
      color:#2C2C2E;
    }

    /* BIG plateau */
    .plate{
      width:min(980px, 94vw);
      margin-top:18px;
      padding:18px;
      border-radius:26px;
      border:1px solid var(--border);
      background:rgba(0,0,0,.015);
      box-shadow:0 26px 80px rgba(0,0,0,.10);
      display:flex;
      flex-direction:column;
      gap:14px;
      animation:fadeUp .65s var(--easeOut) both;
      animation-delay:.12s;
      transition:transform .2s var(--easeOut), box-shadow .2s var(--easeOut);
    }

    .plate:hover{
      transform:translateY(-2px);
      box-shadow:0 30px 90px rgba(0,0,0,.12);
    }

    /* Drop zone feedback */
    .drop{
      border:1px dashed rgba(0,0,0,.20);
      border-radius:20px;
      padding:18px 16px;
      text-align:center;
      background:rgba(0,0,0,.012);
      display:flex;
      flex-direction:column;
      gap:10px;
      align-items:center;
      justify-content:center;
      min-height:120px;
      transition:background .2s var(--easeOut), border-color .2s var(--easeOut), transform .2s var(--easeOut);
    }
    .drop.isDragOver{
      background:rgba(0,0,0,.02);
      border-color:rgba(0,0,0,.28);
      transform:scale(1.01);
    }

    .fileLine{
      font-size:12px;
      color:var(--muted);
      max-width:90%;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }

    /* Buttons */
    .btn{
      border:1px solid var(--border);
      background:#fff;
      border-radius:999px;
      padding:9px 14px;
      font-size:13px;
      cursor:pointer;
      transition:transform .12s var(--easeOut), opacity .15s var(--easeOut), background .2s var(--easeOut), border-color .2s var(--easeOut);
      user-select:none;
    }
    .btn:hover{transform:translateY(-1px);}
    .btn:active{transform:scale(.98);}

    .btnPrimary{
      background:#2C2C2E;
      color:#fff;
      border-color:#2C2C2E;
      font-weight:650;
    }

    .btnDisabled{opacity:.5;pointer-events:none}

    .divider{height:1px;background:rgba(0,0,0,.06); margin:2px 0}

    /* Format section */
    .formatBlock{display:none}
    .centerStack{
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:10px;
      padding:6px 0 2px;
    }

    .label{
      font-size:11px;
      letter-spacing:.08em;
      text-transform:uppercase;
      color:rgba(60,60,67,.55);
    }

    select{
      width:min(420px, 84vw);
      padding:10px 12px;
      border-radius:14px;
      border:1px solid var(--border);
      font-size:14px;
      background:#fff;
      outline:none;
    }

    .qualityWrap{
      display:none;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      justify-content:center;
      margin-top:4px;
    }

    .qualityWrap .qSmall{
      font-size:12px;
      color:var(--muted);
    }

    input[type=range]{
      width:240px;
      accent-color:#2C2C2E;
    }

    .actions{
      display:flex;
      gap:10px;
      justify-content:center;
      margin-top:6px;
    }

    /* Result row */
    @keyframes slideIn{
      from{opacity:0; transform:translateY(8px);}
      to{opacity:1; transform:translateY(0);}
    }
    .doneRow{
      display:none;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding:12px 14px;
      border-radius:18px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.70);
      backdrop-filter:saturate(1.4) blur(10px);
      transition:opacity .2s var(--easeOut);
    }
    .doneRow.isVisible{
      animation:slideIn .35s var(--easeOut) both;
    }

    .doneMeta{
      display:flex;
      flex-direction:column;
      gap:2px;
      min-width:0;
    }
    .doneName{
      font-size:13px;
      font-weight:650;
      color:var(--title);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width:560px;
    }
    .doneSize{
      font-size:12px;
      color:var(--muted);
    }

    .sig{
      margin-top:2px;
      text-align:right;
      font-size:12px;
      color:rgba(60,60,67,.45);
      font-family:"Times New Roman",Times,serif;
    }

    /* Mobile tweaks */
    @media (max-width: 720px){
      main{padding:84px 16px 60px}
      .plate{padding:14px}
      input[type=range]{width:200px}
      .doneName{max-width:240px}
    }
  </style>
</head>

<body>
  <!-- ✅ Topbar -->
  <script src="./topbar.js"></script>

  <main>
    <div class="shell">
      <h1>Convert. Download. Done.</h1>
      <p class="sub">Pick a file. Choose a format. Download the result.</p>
      <div class="plate" id="plate">
        <input type="file" id="fileInput" hidden>

        <div class="drop" id="dropZone">
          <div class="fileLine" id="fileLabel">No file selected</div>
          <button class="btn btnPrimary" id="pickBtn">Select file</button>
        </div>

        <div class="divider"></div>

        <div class="formatBlock" id="formatBlock">
          <div class="centerStack">
            <div class="label">Output format</div>

            <select id="formatSelect">
              <option value="">Choose format</option>
            </select>

            <div class="qualityWrap" id="qualityWrap">
              <span class="qSmall">Quality</span>
              <input type="range" min="0.40" max="0.95" step="0.01" value="0.90" id="quality">
              <span class="qSmall" id="qLabel">0.90</span>
              <span class="qSmall" id="estSize">—</span>
            </div>

            <div class="actions">
              <button class="btn btnPrimary btnDisabled" id="convertBtn">Convert</button>
            </div>
          </div>
        </div>

        <div class="doneRow" id="doneRow">
          <div class="doneMeta">
            <div class="doneName" id="doneName">Ready</div>
            <div class="doneSize" id="doneSize">—</div>
          </div>
          <a class="btn btnPrimary" id="downloadBtn" href="#" download>Download</a>
        </div>

        <div class="sig">-Shala Software</div>
      </div>
    </div>
    <div style="flex:1"></div>
    <div class="footerBar">
      <a class="btn" href="./contact.html">Contact</a>
    </div>
  </main>

  <!-- Core -->
  <script src="./zip4-core.js?v=1"></script>

  <script>
    const fileInput   = document.getElementById('fileInput');
    const pickBtn     = document.getElementById('pickBtn');
    const fileLabel   = document.getElementById('fileLabel');
    const dropZone    = document.getElementById('dropZone');

    const formatBlock = document.getElementById('formatBlock');
    const formatSelect= document.getElementById('formatSelect');

    const qualityWrap = document.getElementById('qualityWrap');
    const quality     = document.getElementById('quality');
    const qLabel      = document.getElementById('qLabel');
    const estSize     = document.getElementById('estSize');

    const convertBtn  = document.getElementById('convertBtn');

    const doneRow     = document.getElementById('doneRow');
    const downloadBtn = document.getElementById('downloadBtn');
    const doneName    = document.getElementById('doneName');
    const doneSize    = document.getElementById('doneSize');

    let currentFile = null;
    let estimateTimer = null;

    function fmt(bytes){
      if(bytes < 1024) return bytes + ' B';
      if(bytes < 1024*1024) return Math.round(bytes/1024) + ' KB';
      return (bytes/1024/1024).toFixed(1) + ' MB';
    }

    function isQualityFormat(m){
      return (m === 'image/jpeg' || m === 'image/webp' || m === 'image/avif');
    }

    function scheduleEstimate(){
      if(estimateTimer) clearTimeout(estimateTimer);
      estimateTimer = setTimeout(updateEstimate, 250);
    }

    async function updateEstimate(){
      const out = formatSelect.value;
      if(!currentFile || !isQualityFormat(out)){
        estSize.textContent = '—';
        return;
      }
      estSize.textContent = '…';
      try{
        const res = await Zip4Core.convert(currentFile, out, { quality: quality.value });
        estSize.textContent = '≈ ' + fmt(res.blob.size);
        if(res.previewUrl) URL.revokeObjectURL(res.previewUrl);
      }catch{
        estSize.textContent = '—';
      }
    }

    function resetResult(){
      doneRow.style.display = 'none';
      doneRow.classList.remove('isVisible');
      // revoke old url if any
      if(downloadBtn.dataset.url){
        try{ URL.revokeObjectURL(downloadBtn.dataset.url); }catch{}
        delete downloadBtn.dataset.url;
      }
      downloadBtn.href = '#';
      doneName.textContent = 'Ready';
      doneSize.textContent = '—';
    }

    pickBtn.onclick = () => fileInput.click();

    // Drag & drop
    ;['dragenter','dragover'].forEach(evt=>{
      dropZone.addEventListener(evt, (e)=>{
        e.preventDefault();
        e.stopPropagation();
        dropZone.classList.add('isDragOver');
      });
    });
    ;['dragleave','drop'].forEach(evt=>{
      dropZone.addEventListener(evt, (e)=>{
        e.preventDefault();
        e.stopPropagation();
        dropZone.classList.remove('isDragOver');
      });
    });
    dropZone.addEventListener('drop', (e)=>{
      const f = e.dataTransfer.files && e.dataTransfer.files[0];
      if(f){
        fileInput.files = e.dataTransfer.files;
        handleFileSelected(f);
      }
    });

    fileInput.onchange = () => {
      const f = fileInput.files && fileInput.files[0];
      if(f) handleFileSelected(f);
    };

    async function handleFileSelected(file){
      currentFile = file;
      fileLabel.textContent = file.name;
      resetResult();

      // populate outputs
      formatSelect.innerHTML = '<option value="">Choose format</option>';
      const outs = await Zip4Core.getOutputsForFile(file);

      for(const o of outs){
        const opt = document.createElement('option');
        opt.value = o.value;
        opt.textContent = o.label;
        formatSelect.appendChild(opt);
      }

      formatBlock.style.display = 'block';
      convertBtn.classList.add('btnDisabled');

      // reset UI
      qualityWrap.style.display = 'none';
      estSize.textContent = '—';
    }

    formatSelect.onchange = () => {
      const v = formatSelect.value;
      convertBtn.classList.toggle('btnDisabled', !v);

      qualityWrap.style.display = isQualityFormat(v) ? 'flex' : 'none';
      scheduleEstimate();
    };

    quality.oninput = () => {
      qLabel.textContent = Number(quality.value).toFixed(2);
      scheduleEstimate();
    };

    convertBtn.onclick = async () => {
      if(!currentFile) return;
      const out = formatSelect.value;
      if(!out) return;

      convertBtn.classList.add('btnDisabled');
      convertBtn.textContent = 'Converting…';

      try{
        const res = await Zip4Core.convert(currentFile, out, { quality: quality.value });

        // Make URL + show row
        const url = URL.createObjectURL(res.blob);
        downloadBtn.href = url;
        downloadBtn.download = res.outName;
        downloadBtn.dataset.url = url;

        doneName.textContent = res.outName;
        doneSize.textContent = fmt(res.blob.size);
        doneRow.style.display = 'flex';

        // animate in
        requestAnimationFrame(()=> doneRow.classList.add('isVisible'));

        // keep estimate aligned with actual for quality formats
        if(isQualityFormat(out)) estSize.textContent = '≈ ' + fmt(res.blob.size);
      }catch(err){
        alert(err?.message || 'Conversion failed.');
      }finally{
        convertBtn.textContent = 'Convert';
        convertBtn.classList.toggle('btnDisabled', !formatSelect.value);
      }
    };
  </script>
</body>
</html>